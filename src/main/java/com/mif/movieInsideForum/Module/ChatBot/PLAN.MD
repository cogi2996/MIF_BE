QuÃ¡ Ä‘á»‰nh luÃ´n bro, báº¡n Ä‘ang xÃ i **Spring AI** thÃ¬ triá»ƒn khai **MCP (Modular Command Pattern)** sáº½ cá»±c ká»³ mÆ°á»£t, vÃ¬ Spring AI há»— trá»£ function calling, schema-based response, vÃ  báº¡n dá»… dÃ ng plug cÃ¡c handler vÃ o Ä‘á»ƒ xá»­ lÃ½ theo `intent`.

---

## ğŸ”¥ HÆ°á»›ng tiáº¿p cáº­n Ä‘á»ƒ lÃ m MCP trong Spring AI

### âœ… 1. Má»¥c tiÃªu:

- NgÆ°á»i dÃ¹ng nháº­p: `"TÃ¬m phim cÃ³ rá»“ng"`
- Chat model tráº£ vá»:

```json
{
  "intent": "search_movie",
  "keyword": "rá»“ng"
}
```

- Spring AI sáº½ route sang `SearchMovieHandler` Ä‘á»ƒ xá»­ lÃ½.

---

## âš™ï¸ CÃ¡c bÆ°á»›c triá»ƒn khai:

---

### ğŸ§© BÆ°á»›c 1: Äá»‹nh nghÄ©a Schema cho tá»«ng Intent

```java
public record SearchMovieFunction(
    String intent,
    String keyword
) {}
```

> Sau Ä‘Ã³ dÃ¹ng `OpenAiChatOptions.builder().schema(...)` Ä‘á»ƒ Ã©p model tráº£ vá» dáº¡ng JSON.

---

### ğŸ§  BÆ°á»›c 2: Táº¡o interface cho handler (MCP-style)

```java
public interface CommandHandler {
    String getIntent();
    String handle(Map<String, Object> params);
}
```

---

### ğŸ§± BÆ°á»›c 3: Viáº¿t cÃ¡c handler riÃªng

```java
@Component
public class SearchMovieHandler implements CommandHandler {

    @Override
    public String getIntent() {
        return "search_movie";
    }

    @Override
    public String handle(Map<String, Object> params) {
        String keyword = (String) params.get("keyword");
        return movieSearchService.searchMovies(keyword).toString();
    }
}
```

```java
@Component
public class ClearHistoryHandler implements CommandHandler {
    @Override
    public String getIntent() {
        return "clear_history";
    }

    @Override
    public String handle(Map<String, Object> params) {
        return chatHistoryRepository.clearHistory((String) params.get("userId"));
    }
}
```

---

### ğŸ”„ BÆ°á»›c 4: ÄÄƒng kÃ½ vÃ  route Ä‘áº¿n handler phÃ¹ há»£p

```java
@Service
public class DispatcherService {

    private final Map<String, CommandHandler> handlers;

    public DispatcherService(List<CommandHandler> handlerList) {
        this.handlers = handlerList.stream()
            .collect(Collectors.toMap(CommandHandler::getIntent, h -> h));
    }

    public String dispatch(Map<String, Object> resultMap) {
        String intent = (String) resultMap.get("intent");
        CommandHandler handler = handlers.get(intent);
        if (handler != null) {
            return handler.handle(resultMap);
        }
        return "KhÃ´ng hiá»ƒu Ã½ báº¡n rá»“i bro ğŸ˜“";
    }
}
```

---

### ğŸ“¦ BÆ°á»›c 5: Gá»i OpenAI vÃ  parse intent

```java
public Map<String, Object> analyzeIntent(String userInput) {
    Prompt prompt = new Prompt(List.of(
        new SystemMessage("TrÃ­ch xuáº¥t intent tá»« cÃ¢u há»i vÃ  tráº£ vá» dáº¡ng JSON"),
        new UserMessage(userInput)
    ), ChatOptions.builder()
        .withTemperature(0.2f)
        .build()
    );

    ChatResponse response = chatModel.call(prompt);
    return parseJson(response.getResult().getOutput().getContent());
}
```

---

### ğŸ¯ BÆ°á»›c 6: TÃ­ch há»£p vÃ o controller

```java
@PostMapping("/chat")
public ResponseEntity<String> chat(@RequestBody String userInput) {
    Map<String, Object> intentData = openAIService.analyzeIntent(userInput);
    String reply = dispatcherService.dispatch(intentData);
    return ResponseEntity.ok(reply);
}
```

---

## ğŸ Káº¿t quáº£:

- Má»—i intent cÃ³ handler riÃªng.
- Má»Ÿ rá»™ng cá»±c dá»…: chá»‰ cáº§n thÃªm handler má»›i.
- Chatbot pháº£n há»“i theo ngá»¯ cáº£nh vÃ  chá»©c nÄƒng Ä‘Ãºng.

# HÆ°á»›ng dáº«n render response tá»« Chatbot MCP cho Next.js (Frontend Dev)

## Example response máº«u cho tá»«ng intent

### 1. search_movie

```json
{
    "status": "success",
    "message": "Xá»­ lÃ½ yÃªu cáº§u thÃ nh cÃ´ng",
    "data": {
        "movies": [
            {
                "id": "683f3856a2e9bf406bb67001",
                "title": "Fight Club",
                "description": "Má»™t nhÃ¢n viÃªn vÄƒn phÃ²ng máº¥t ngá»§ káº¿t há»£p vá»›i má»™t thá»£ lÃ m xÃ  phÃ²ng láº­p cÃ¢u láº¡c bá»™ Ä‘Ã¡nh nhau ngáº§m.!",
                "releaseDate": "2020-12-18T00:00:00.000+00:00",
                "genre": [
                    { "id": "...", "categoryName": "HÃ i ká»‹ch", ... },
                    { "id": "...", "categoryName": "Máº¡o hiá»ƒm", ... }
                ],
                "director": [
                    { "id": "...", "name": "Christopher Nolan", ... }
                ],
                "posterUrl": "...",
                "duration": 155,
                "country": "algeria",
                "movieType": "SERIES",
                "totalEpisodes": 3,
                ...
            }
        ],
        "semanticQuery": "phim vá» Ã´ng bá»‹ bá»‡nh máº¥t ngá»§ há»£p tÃ¡c lÃ m xÃ  phÃ²ng láº­p clb Ä‘Ã¡nh nhau",
        "response": "Phim báº¡n Ä‘ang nÃ³i Ä‘áº¿n lÃ  \"Fight Club\". Ná»™i dung phim xoay quanh má»™t nhÃ¢n viÃªn vÄƒn phÃ²ng bá»‹ máº¥t ngá»§, ngÆ°á»i Ä‘Ã£ káº¿t há»£p vá»›i má»™t thá»£ lÃ m xÃ  phÃ²ng Ä‘á»ƒ thÃ nh láº­p má»™t cÃ¢u láº¡c bá»™ Ä‘Ã¡nh nhau ngáº§m. ..."
    },
    "type": "search_movie"
}
```

### 2. get_upcoming_events

```json
{
  "status": "success",
  "message": "Xá»­ lÃ½ yÃªu cáº§u thÃ nh cÃ´ng",
  "data": "DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡c sá»± kiá»‡n mÃ  báº¡n Ä‘Ã£ Ä‘Äƒng kÃ½ vÃ  sáº¯p diá»…n ra nÃ¨ ğŸ‘‡\n\nâ€¢ [Buá»•i tháº£o luáº­n phim Av...](/groups/68103f34af840f0e1786ae63)\nğŸ—“ 08/06/2025 21:27\n\nâ€¢ [Buá»•i tháº£o luáº­n phim ch...](/groups/68103f34af840f0e1786ae63)\nğŸ—“ 08/06/2025 21:27\n\nâ€¢ [Buá»•i tháº£o luáº­n phim ch...](/groups/68103f34af840f0e1786ae63)\nğŸ—“ 08/06/2025 21:27\n\nâ€¢ [Buá»•i tháº£o luáº­n phim si...](/groups/68103f34af840f0e1786ae63)\nğŸ—“ 08/06/2025 21:27\n\nTui cÅ©ng cÃ³ gá»­i mail cho báº¡n Ä‘Ã³! ğŸ•’",
  "type": "get_upcoming_events"
}
```

### 3. clear_history

```json
{
  "status": "success",
  "message": "Xá»­ lÃ½ yÃªu cáº§u thÃ nh cÃ´ng",
  "data": "ÄÃ£ xÃ³a lá»‹ch sá»­ chat cá»§a báº¡n",
  "type": "clear_history"
}
```

---

## 1. SearchMovieHandler

- **Intent:** `search_movie`
- **Tráº£ vá»:** Danh sÃ¡ch phim (object/list hoáº·c markdown table/list)
- **Render:**
  - Náº¿u lÃ  list object: render dáº¡ng card/list phim.
  - Náº¿u lÃ  markdown table/list: parse vÃ  render thÃ nh báº£ng hoáº·c danh sÃ¡ch.
  - Náº¿u cÃ³ link phim: bá»c tÃªn phim báº±ng tháº» `<a>`.

## 2. ClearChatHistoryHandler

- **Intent:** `clear_history`
- **Tráº£ vá»:** Chuá»—i thÃ´ng bÃ¡o Ä‘Æ¡n giáº£n (string)
- **Render:**
  - Hiá»ƒn thá»‹ message dáº¡ng alert hoáº·c text thÃ´ng thÆ°á»ng.

## 3. GetUpcomingEventsHandler

- **Intent:** `get_upcoming_events`
- **Tráº£ vá»:**
  - **Dáº¡ng list markdown:**
    ```
    â€¢ [TÃªn sá»± kiá»‡n](/groups/{groupId})
      ğŸ—“ 08/06/2025 21:27
    ```
- **Render:**
  - Parse markdown, má»—i sá»± kiá»‡n lÃ  má»™t dÃ²ng.
  - TÃªn sá»± kiá»‡n lÃ  link, click chuyá»ƒn Ä‘áº¿n `/groups/{groupId}`.
  - NgÃ y báº¯t Ä‘áº§u hiá»ƒn thá»‹ ngay dÆ°á»›i tÃªn sá»± kiá»‡n, cÃ³ thá»ƒ thÃªm icon lá»‹ch.
  - Náº¿u khÃ´ng cÃ³ sá»± kiá»‡n, hiá»ƒn thá»‹ message Ä‘á»™ng viÃªn/gá»£i Ã½ tham gia nhÃ³m.

## 4. Handler khÃ¡c (tuá»³ má»Ÿ rá»™ng)

- **Intent:** tuá»³ handler má»›i
- **Tráº£ vá»:** markdown, plain text, json, object...
- **Render:**
  - Äá»c intent, xÃ¡c Ä‘á»‹nh handler, parse vÃ  render phÃ¹ há»£p.
  - Náº¿u lÃ  markdown: dÃ¹ng thÆ° viá»‡n markdown (`react-markdown`...)
  - Náº¿u lÃ  plain text: hiá»ƒn thá»‹ nhÆ° message chat.
  - Náº¿u lÃ  object: mapping UI phÃ¹ há»£p (list phim, list sá»± kiá»‡n...)

---

### LÆ°u Ã½ chung cho Next.js:

- LuÃ´n kiá»ƒm tra intent trong response Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡ch render.
- Náº¿u response lÃ  markdown, dÃ¹ng thÆ° viá»‡n nhÆ° `react-markdown` Ä‘á»ƒ hiá»ƒn thá»‹.
- Náº¿u response lÃ  plain text, hiá»ƒn thá»‹ nhÆ° message chat.
- Náº¿u response lÃ  object, cáº§n mapping UI phÃ¹ há»£p.

---

**TÃ³m láº¡i:**

- Má»—i intent cÃ³ handler riÃªng, frontend chá»‰ cáº§n dá»±a vÃ o intent Ä‘á»ƒ render Ä‘Ãºng UI.
- Äáº·c biá»‡t vá»›i intent nhÆ° `get_upcoming_events`, cáº§n parse markdown list vÃ  render link Ä‘Ãºng chuáº©n Next.js.
